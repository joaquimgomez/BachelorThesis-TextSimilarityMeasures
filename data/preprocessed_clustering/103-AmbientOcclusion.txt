alchemi screen-spac ambient obscur algorithm morgan mcguir nvidia & william colleg brian osman vicari vision michael bukowski vicari vision padraic hennessi vicari vision figur 1: left: environ lighting. right) modul alchemi ambient obscurance, comput 12 sampl pixel 1280720 3 ms geforc 580. algorithm easi tune, robust, captur darken scale orientations. abstract ambient obscur (ao) produc perceptu import illumi- nation effect darken corners, cracks, wrinkles; prox- imiti darkening; contact shadows. present ao algo- rithm alchemi engin vicari vision com- mercial games. base new deriv screen-spac obscur robustness, insight falloff function cancel term visibl integr favor effici operations. alchemi creat contact shadow conform surfaces, cap- ture obscur geometri vari scale, provid intuit appear parameters: world-spac radiu bias, aesthet intens contrast. algorithm estim obscur pixel sampl point read depth normal buffers. process dynam scene hd 720p resolut 4.5 ms xbox 360 3 ms nvidia geforce580. cr categories: i.3.3 [picture/imag generation]: displai al- gorithms; i.3.7 [three-dimension graphic realism]: color, shading, shadowing, textur keywords: ambient occlusion, ambient obscurance, screen space 1 introduct indirect illumin signific factor realist lighting. ev- eri game approxim indirect light spars larg distances, precomput (e.g., [larsson 2010]; environ map constant ambient classic examples) dynam gener- ation (e.g., [kaplanyan dachsbach 2010; martin einars- son 2010]). spars method miss occlus small, sub- e-mail: meter scale. ambient obscur (ao) illumin term correct indirect light scale proport point vis- ibl obscur scale. point local obscur direct receiv littl indirect illumin dis- tant objects, highli access point receiv indirect il- lumination. obscur visual import object definition, provid sens scale, spatial cue contact shadow darken concav surfaces. computa- tional intens estim directli scene geometryani point obscur direction. screen space ap- proximations, independ number polygons, proven attract practice. paper present screen space ao algorithm develop specif guitar hero titl subsequ gener integr cross-platform alchemi game engine. figur 1 demonstr visual impact. left imag show scene environ light only. imag right modul light alchemi ao, resolv fine detail spa- tial relationship objects. algorithm follow insights: deriv robust estim render equa- tion; provid tempor coher make estim effici evalu time pixel; achiev effi- cienci shape falloff function cancel expens opera- tions. alchemi address drawback previou screen-spac ao methods, satisfi follow require- ments: 1. robust: conform obscur affect surfac (e.g., shadow float air near silhouettes), limit viewer de- pendenc intensity, maxim tempor coherence. 2. multiscale: captur phenomena multipl scales: shadow deep pits, corner darkening, contact shadows, wrinkles. 3. artist-control: provid intuit paramet larg sweet- spot predict quality. 4. scalable: comput 3-5 ms, xbox 360 window direct3d 11 hardwar vari quality. like screen-spac methods, limit sampl varianc (address edge-awar filtering) under-obscur unseen occlud depth buffer surfac outsid field view. render guard band viewport re- duce latter. attribut visual fidel robust alchemi ao compar phenomenolog method radio- metric derivation, physic correct. valu algorithm make practic concess artist perform goals. 1.1 relat work screen space luft et al. [2006] observ place blurri black line depth discontinu screen space unsharp mask increas visual contrast similarli ambient occlusion. line effici screen-spac ao method rapidli followed, publish oral present base product use. develop effici gpu sampl [shanmugam arikan 2007; mittr 2007; kajalin 2009] reconstruct [filion mcnaughton 2008] methods, increasingli physically-bas deriva- tion [bavoil sainz 2009a; szirmay-kalo et al. 2010; loo sloan 2010], multipass method address per- formanc qualiti issu [ritschel et al. 2009; bavoil sainz 2009b]. techniqu build work revisit core derivation, focu section 2. report experi- mental result compar alchemi recent method section 3. briefly, volumetr obscur [loo sloan 2010; ownbi et al. 2010] estim occlus proport vol- umetr occlus point, tend produc black halos. alchemi us project solid-angl occlusion, like horizon-bas ao [bavoil sainz 2009a], us effici sampl scheme avoid over-darken conserv assum unseen space empty, like vo does. low-level sampl tech- niqu method base earlier work crytek [mit- tring 2007; kajalin 2009] incorpor filter aesthet falloff method starcraft ii [filion mcnaughton 2008]. geometr comput ao geometri avoid viewer- depend error screen-spac approximations, cost perform complex scenes.. briefli geometr method real-tim rendering, i.e., factor 20 perform screen-spac methods. real time ren- dere [akenine-mol et al. 2008] broad survey. oat sander [2007] precomput access cone texel static mesh, appli dynam illumi- nation. reinboth et al. [2009] dynam voxel polygon scene sampl occlus voxel space. bunnel [2005] com- pute occlus gpu multipl pass per-vertex proxi geometry. ambient occlus field [kontkanen lain 2005] pre- comput voxel occlus valu rel static mesh, compos move rigid object estim ao. mcguir [2010] lain karra [2010] extend idea dynam meshes. 2 algorithm begin summar kei term equat govern indirect illumination. previou screen space method approxim equat (or result phenomena) wai ex- treme effici introduc signific error. instead re- tain model observ falloff function customarili chosen aesthet select elimin expens operations. this, abl retain radiometr model screen-spac sampl step. process lead rel robust solution. augment screen-spac solut paramet manag buffer precis artist goal product use. 1. render earlyz pass 2. render cameraspac normal posit buffer 3. render ambient obscur buffer 4. [render effects] 5. crossbilater filter obscur 6. composit obscurance, texture, light forward pass list 1: render context obscurance. list 1 describ ao algorithm context larger multi-pass render system. algorithm compris obscur pass 3 filter pass 5. implement ei- ther render full-screen rectangl shader read posit normal buffers, forward pass scene geometry. environ light, shadows, direct illumin comput pass 6, forward lighting, step 4 defer shading. final composit pass us multisampl antialias (msaa) appli screen-resolut obscur subpixel edg precision. gather obscur pixel cross pattern cross- bilater filter base camera-spac proxim sur- face shaded. defer shade pass substitut pass 6 loss antialiasing. 2.1 background let distance-limit radianc function lx(c, ) denot radi- anc incid pointc unit direct , point ball radiu x c. let visibl function v (c,p ) 1 intersect open-end line segment cp scene, 0 otherwise. net incid radianc func- tion sum near field radianc far field radianc mod- ulat visibl [arikan et al. 2005; mcguir 2010] given radiu r, l(c, ) = lr(c, ) + v (c,c + r)l(c + r, ). (1) decomposit us combin estim near far field illumin differ algorithms. common real-tim render choos radiu r meter sep- arat far-field v l term shadow direct illumin ambient-occlud environ light terms. com- mon ignor small-scal global illumin assum lr0, recent screen-spac gather method offer accu- rate altern [ritschel et al. 2009; soler et al. 2010]. ambient occlus (see [landi 2002]) surfac point c normal n ao r (c, n) = 1a r(c, n), (2) 0 ar(c, n) 1 fraction visibl far field c [cook torranc 1982]. function visibl weight project area posit hemisphere, r(c, n) = 1 v (c,c + r) n d. (3) note ( n) eqn 3 account solid angl occlud project tangent plane c. example, decreas impact occlud block incid light shallow angles, radiometr correct. specifically, pro- ject area factor later appli indirect illumination, doubl count factor. shadow account visibl factor direct illumination. ob- scuranc approxim shadow indirect illumin modul environ light. transit smoothli near- far-field illumin models, ambient occlus extend ambient obscur (ao) [zhukov et al. 1998] falloff function reduc influenc occlus distance. analog obscur function ar(c, n)=1 [1v (c+min(t(c, ) + , r))]g(t)(n) d (4) t distanc c scene point encount rai cast direct 0 g(x) 1 aesthetically- select falloff function, commonli obei g(x) = 0|xr g(0) = 1. remaind paper omit paramet function, r, c, n. 2.2 deriv obscur estim deriv robust estim obscur intuit pa- ramet aesthet falloff. particular falloff function lead extrem effici implementation. let subset hemispher exist distanc 0 < t(c, )< r rai fromc direct intersect scene. is, set near-field occlud project unit sphere. cover near occluders, visibl term eq. 4 zero it: v (c, min (t(c, ) + , r)) = 0 . (5) chang integr domain eq. 4 give = 1 g (t(c, )) n d. (6) choos falloff function g(t) = u t max(u, t)2, re- sembl shift hyperbola filion mcnaughton [2008] report artist desir starcraft ii (figur 2) lead remark simplif geometr construct. substi- tute eq. 6: = 1 ut(c, ) max(u, t(c, ))2 n d. (7) rewrit term vector ~v() = t(c, ) c occlud (p figur 3). = ~v()/||~v()|| t(c, ) = ||~v||, = 1 u ~v() n max (u2, ~v() ~v()) d. (8) numer estim integr sampl set {i} s di- rection uniformli random, giving: 1 2u s s i=1 max(0, ~vi n) h(r ||~vi||) max(u2, ~vi ~vi) . (9) h(x) heavisid step function. 2.3 screen-spac approxim practic application, evalu radiometrically-bas es- timat eq. 9 screen space sampl depth posit buffer, introduc concess finit precision, extend re- sult aesthet control artists. choos sampl manner loo sloan [2010]: consid disk radiu r center c par- allel imag plane, select screen-spac point q uniformli 0.00 0.10 0.20 0.30 0.40 0.50 0.60 0.70 0.80 0.90 1.00 0 0.2 0.4 0.6 0.8 1 occlud distanc t / r alchemy, u = 0.10 r alchemy, u = 0.05 r starcraft ii figur 2: plot falloff g(t)vs. t alchemi starcraft ii ao. new alchemi algorithm c q n p v r imag plane figur 3: geometr construct alchemi ao. random projection, read depth posit buffer camera-spac scene point p = (xp , yp , z(q)) ray. figur 3 summar process. select bias sampl ball c project ellipse, disk. like loo sloan, ignor sourc error rel small typic field view 70 degrees. augment solut express paramet intens scale () contrast (k) allow intent over- under- occlusion, nomin scale intens 1/ = 1.0 k = 1.0 produc us baseline. practice, falloff constant u eq. 9 serv avoid di- vision zero interfer set independently, elimin numer replac max(u2, ~vi ~vi) denomin ~vi ~vi + . choos larg prevent un- derflow small corner white light leaks. valu order magnitud = 0.0001 produc indistinguish results. bia distanc ambient-obscur analog shadow map bias: increas reduc self-shadow (figur 4), decreas light leak corners. scale z (which negative) effici compens dot product increasingli sensit error n distant points. final equat is: max ( 0, 1 2 s s i=1 max(0, ~vi n+ zc) ~vi ~vi + )k (10) paramet straightforward adjust in- tuitiv interpret reason valu work larg rang scenes. obscur maximum world-spac radiu r occur object closer . there, tune appearance. imag paper us r = 0.5m, = 1, k = 1, = 104m specifi (n.b., art director game prefer overdarken higher intens contrast this). figur 4: view 8-bit normal 16-bit positions. radiu larg gear 0.8 m. left: self-occlus = 0 m. right: correct = 104 m. figur 5: diminish sampl count distance. (the horizon- tal band aris interpol vertex normal coars tessellationif undesired, elimin finer tessellation, face normals, per-surfac values.) figur 6: left: raw obscur 12 sampl pixel; right: 13-tap 1d cross-bilater filter passes. 3 result report result scene divers geometry: industrial, giant machin occlus scales. knight charact interact environment. rock grass natur scene. [baraka 2010] sponza architectur benchmark long sight-lines. [meinl 2009] orc charact head organ curves. [3d hannib 2008] dragon model scan stanford (10 cm tall). [stanford 1996] studio demonstr applic pro- duction game assets. publicli available. accompani paper set video result render window pc xbox 360 demonstr tempor coher camera charact motion. pc version, guard band region on-screen reveal loss obscur figur 7: left: environment-lit character; right: alchemi ao en- hanc fold wrinkles. r = 0.2 region. normal render slightli larger imag crop blur; add 0.2 ms render time geforc 580. figur 1 show obscur industri vari scale orien- tations. scene sharp concav convex corners, lay- ers, curv cover import cases; figur 7 demon- strate obscur organ shape orc model. darken vertic larg platform disk lower right industri undesir consist model. locat interpol vertex nor- mal indic tangent plane pass beneath nearbi ver- tices. reduc comput ao face- instead interpolated-normals, increas tessellation. figur 8 show increas radiu r hold number sampl constant increas rang obscur phenomena cost sharpness. farther-back gear gradual darker radiu grow captur influenc higher lay- ers. larg radii visual desir incur costs. sampl requir reduc variance. second perform fall r increas sampl near c correspond position-buff locat like cache, point distant screen space like cached. previou screen-spac ambient occlus algorithm properti wide known industry, rare report literature. figur 9 show correspond render time geforc 580 12 sampl pixel. probabl cach hit the- oret proport r2, observ favorable, nearly-linear slowdown. attribut interact small sampl count compar cach line size, flat parabola. r > 1.5m scene fetch cach misses, time plateaus. band lod increas perform screen- space project r small mean perform alchemi ao increas view deep scene, wide field view. precis case part ren- dere tend lose performance, particl system raster itself, object larger depth rang visible. properti help balanc total frame ren- dere time. figur 10 compar volumetr obscur [loo sloan 2010], recent previou work, alchemi ao. row industri scene row show sponza scene. tune algorithm compar performance: figur 12: left: environment-lit untextur rock grass scene; right: alchemi ao. figur 13: frame dynam 2 m tall frog knight charact move camera knight scene xbox 360, light term materials. rightmost frame show obscur buffer. r = 0.76 m xbox 360 geforc 460 se ~d3d9 d3d9 samples/band 3 4 4 3 2 maximum band 1 1 3 3 3 regist 6 vec4 15 scalar 15 scalar 15 scalar 15 scalar 32-bit words/pix io 28 28 40 31 22 access time 2.3 ms 0.6 ms 2.0 ms 1.5 ms 1.0 ms filter pixel width 11 11 13 13 9 filter time 2.0 ms 1.6 ms 1.0 ms 1.0 ms 0.7 ms d3d11 / gl4 geforc 580 gtx tabl 1: sampl count hold worst-cas perform constant vari qualiti low, mid, high-end systems. geforc 460 se gpu, volumetr obscur comput obscu- ranc 0.7 ms alchemi run 0.6 ms. volumetr obscu- ranc run resolutions, take sampl pixel resolution. alchemi us sampl pixel test; re- ceiv fewer sampl read normal posit instead depth values. volumetr obscur run half perfor- manc normal better captur fine detail, redun- dant multipl resolutions. alchemi ao right figur 10, exhibit desir prop- erties. row show conform surfac (b) instead shadow float air near silhouett (a). import properli plant pillar feet. second row demonstr fast robust oper larg radius, oc- clusion appear continu rang geometr frequencies. row combin challeng case continu distanc range. figur 11 compar bavoil sainz [2009a] implement horizon-bas ao (hbao) alchemi ao dragon scene geforc 580. hbao give smoother result (a). alchemi captur fine detail (b) consist intens (c) view changes, screen-spac effect limit view dependence. note intens dark shadow hbao. conserv alchemi result aris adopt looss sloan [2010] assumpt unseen space empty. alchemi result exhibit higher tempor coher camera motion oper screen resolut (see video); hbao upsampl substanti take 22 ms run resolut avoid aliasing. figur 12 show natur scene dens clump grass blade large, smooth rocks. appear foliag strongli depend ambient occlusion. alchemi high sampl resolu- tion compar screen space method make suit captur interact objects. figur 13 show frame sequenc captur xbox 360 result video. anim charact deform anim establish break contact ground se- quence. unlik method process ao low resolut upsampl significantly, alchemi sampl multipl time pixel distribut sampl space angle, provid high spatial resolut good estim robust object camera motion. figur 8: vari obscur radiu r industri scene. 0.0 0.5 1.0 1.5 2.0 2.5 3.0 0.0 0.5 1.0 1.5 2.0 r meter t im e (m s) figur 9: increas radiu increas number textur cach miss render time. tabl 1 compar algorithm platform view sponza figur 10, show rang distanc sky (sinc sky pixel inexpensive). target 2-4 ms to- tal cost comput filter obscurance. algorithm bandwidth-limited, maintain approxim constant perfor- manc reduc number sampl pixel lower-end hardware, cost higher nois platforms. rgb8 cost four-byt word rgb16f posit depth32 cost word fetch memori layout, total band- width cost higher number usabl byte read. context game, exploit amort cost filter effects. example, includ soft shadows, indirect illumination, noisi stochast particl unus channel obscur buffer simultan blurring. microsoft pix tool report xbox 360 implemen- tation maintain 90% alu utilization. 4 discuss alchemi ao algorithm meet product need fast plausibl ambient occlus intuit aesthet parameters. combin effect element techniqu previous proven industri context develop crytek, avalanche, blizzard extend new deriv increas perform robustness. algorithm stabl larg rang paramet natur leverag perform abil specif target gpu adjust sampl count (i.e., volumetr obscur alchemi ao [loo sloan 2010] [thi paper] figur 10: qualiti comparison recent previou work compar performance. aspect especi sought improv pillar row intersect floor a) volumetr obscur produc occlus float air silhouette; b) alchemi ao conform ground orientation. horizon-bas ao alchemi ao [bavoil sainz 2009a] [thi paper] figur 11: dragon view crop 1280720. left: hbao optim enabl (8.5 ms). right: alchemi ao (2.6 ms) r = 0.1. variance) sampl radius. anticip futur gpu perform increas ge- ometr method light transport standard real-tim rendering. however, anticip resolut geometr complex increasing. possibl gener light-transport method practic captur small-scal occlu- sion model aoindeed, offlin render system seek effici explicit ao approxim (e.g., [bunnel 2005]). expect alchemi ao method like us time come. direct futur work estim local indirect illumina- tion sampl color buffer occlus sampl taken alchemi algorithm. local screen-spac spec- ular reflect work surprisingli games, activ work screen-spac diffus glossi reflection. in- teract multipl surfac light transport path make physic similar ao problem simul indirect light present compar perform robust challenges. algorithm like alchemi natur candid extension. however, remain open ao algorithm gener ex- tensibl viabl estim indirect light, human percept alias bia indirect light dif- ferent shadows. acknowledg thank nati hoffman (activis studio central) check equat carefulli support public algorithm game publish activision, artist nathan hawkinson, justin wharton, kevin dobler, brent gibson creat game scene paper, entir team vicari visions. refer 3d hannibal, 2008. orc head. models/orc-head-3d-3ds/420140. akenine-moller, t., haines, e., hoffman, n. 2008. real-tim render 3rd edition. a. k. peters, ltd., natick, ma, usa. arikan, o., forsyth, d. a., obrien, j. f. 2005. fast detail approxim global illumin irradi de- composition. acm trans. graph. 24, 3, 11081114. baraka, 2010. rock 02, may. bavoil, l., sainz, m. 2009. multi-lay dual-resolut screen-spac ambient occlusion. shaderx7, w. engel, ed. bavoil, l., sainz, m. 2009. multi-lay dual-resolut screen-spac ambient occlusion. siggraph 2009: talks, acm, 11. bunnell, m. 2005. dynam ambient occlus indirect lighting. nvidia corporation. cook, r. l., torrance, k. e. 1982. reflect model graphics. acm trans. graph. 1 (january), 724. filion, d., mcnaughton, r. 2008. effects&techniques. insiggraph2008 courses, acm,133164. iones, a., krupkin, a., sbert, m., zhukov, s. 2003. fast, realist light video games. ieee comput. graph. appl. 23, 3, 5464. kajalin, v. 2009. screen space ambient occlusion. shaderx7, w. engel, ed. charl river media, march. kaplanyan, a., dachsbacher, c. 2010. cascad light propag volum real-tim indirect illumination. pro- ceed i3d 2010, acm, i3d 10, 99107. kaplanyan, a. 2010. cryengin 3: reach speed light. siggraph 2010 courses, acm. kontkanen, j., laine, s. 2005. ambient occlus fields. proceed i3d 2005, acm press, 4148. laine, s., karras, t. 2010. method fast ray- cast ambient occlusion. graphic forum (proc. euro- graphic symposium render 2010) 29, 4. landis, h. 2002. product readi global illumination. sig- graph 2002 courses, 331338. larsson, d. 2010. pre-comput light games. sig- graph 2010 courses, acm. global illumin in- dustries, jaroslav/gicourse2010/. loos, b. j., sloan, p.-p. 2010. volumetr obscurance. proceed i3d 2010, acm, 151156. luft, t., colditz, c., deussen, o. 2006. imag en- hancement unsharp mask depth buffer. acm transac- tion graphic 25, 3 (jul), 12061213. martin, s., einarsson, p. 2010. real-tim radios ar- chitectur video games. siggraph 2010 courses, acm. mcguire, m. 2010. ambient occlus volumes. proceed high perform graphic 2010. meinl, f., 2009. crytek sponza. refin marco dabrov model. miller, g. 1994. effici algorithm local global acces- sibil shading. siggraph 1994, acm, 319326. mittring, m. 2007. find gen: cryengin 2. sig- graph 2007 courses, acm, 97121. nvidia, 2009. enabl ambient occlus games. onlin geforc guide, view april 3, 2011. oat, c., sander, p. v. 2007. ambient apertur lighting. proceed i3d 2007, acm, 6164. ownby, j.-p., hall, r., hall, c. 2010. render tech- niqu toi stori 3. siggraph 2010 courses, acm. reinbothe, c., boubekeur, t., alexa, m. 2009. hy- brid ambient occlusion. eurograph 2009areaspapers. ritschel, t., grosch, t., seidel, h.-p. 2009. approxi- mate dynam global illumin imag space. proceed- ing i3d 2009, acm, 7582. shanmugam, p., arikan, o. 2007. hardwar acceler ambient occlus techniqu gpus. proceed i3d 2007, acm, 7380. soler, c., hoel, o., rochet, f. 2010. defer shade pipelin real-tim indirect illumination. siggraph 2010 talks, acm. stanford, 1996. dragon reconstruct cyberwar scan. stewart, a. j., langer, m. s. 1997. accur recoveri shape shade diffus lighting. ieee transact pattern analysi machin intellig 19, 10201025. szirmay-kalos, l., umenhoffer, t., toth, b., szecsi, l., sbert, m. 2010. volumetr ambient occlus real- time render games. ieee cg&a 30, 1, 7079. zhukov, s., iones, a., kronin, g. 1998. ambient light illumin model. render techniqu 98, springer- verlag wien new york, g. drettaki n. max, eds., euro- graphics, 4556.
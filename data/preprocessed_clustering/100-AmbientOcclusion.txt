effici method ambient light tama umenhoff tu budapest balaz toth tu budapest laszlo szirmay-kalo tu budapest abstract paper present model algorithm reflect ambient light. simplifi render equat deriv ambient transfer function express respons surfac neighborhood ambient lighting, take account mul- tipl reflect effects. ambient transfer function built obscur point. assumpt materi properti local homogen incorpor real-tim ob- scuranc algorithms, propos ambient transfer evalu real-time. model physic base provid better result empir ambient occlus techniqu cost, reveal tradeoff accuraci efficiency. 1 introduct graphics, materi usual defin brdf optic respons point direct illumina- tion. however, real life indirect illumin caus mul- tipl reflect distant surfac act like sky light sourc roughli uniform intens differ directions. optic respons unocclud homogen illumin albedo, obtain brdf integration. occlus happen, consid illumi- nation effect direct sourc occlud surfac objects. occlus factor pre- comput static scene approxim on-lin propos real-tim ambient occlus methods. method plai role shadow algorithm ambient lighting. classic shadow map point direct light ambient occlu- sion overdo role sens complet elimin light surfac directli visibl sources, make surfac darker be. case point direct lights, compens darken effici way, classic ambient light model used. extend compens ambient occlus well, definit gener similar global illumin ap- proaches. accord intuit albedo integr brdf ambient occlus integr visibl factor shad- ow algorithms, follow line research brdf model visibl computation. however, worth con- sider techniqu directli attack ambient lighting. paper focus fast comput reflect ambient light. shall assum primari sourc illumi- nation scene homogen sky light sourc intens la. approach approxim physic based. is, deriv model render equat appli seri approximations. deriv theoret interest, show intim relationship approxim physic model open new direct compromis accuraci cost evaluation. respect, model find bridg obscur ambi- ent occlus render equation. 2 previou work oldest ambient light model assum ambient light la constant point directions, point reflect kala intensity. model ignor geometri scene, result imag plain 3d appearance. physic correct approach solut render- ing equat account factor miss classic ambient light model. however, approach ex- pensiv computation dynam scene need render real-time. instead work render equation, local approach examin neighborhood shade point. obscur method [zhukov et al. 1998; ion et al. 2003] comput open scene neighborhood point, scale ambient light accordingly. method call ambient occlus [hayden 2002; pharr green 2004; kontkanen aila 2006] approxim solid angl averag direct neighborhood open, us environ map illu- minat instead ambient light. spectral obscur method averag spectral reflect neighborhood scene taken account, color bleed- ing effect cheapli simul [mendez et al. 2005; bunnel 2005]. ambient occlus obscur usual off-lin meth- ods, store result texture. appli simplifications, however, real-tim gener possible. ambient oc- clusion integr local visibility, real-tim ambient occlu- sion method reli scene represent visibl easili determined. scene represent includ ap- proxim surfac disk [bunnel 2005; hoberock jia 2007] sphere [shanmugam arikan 2007]. alternatively, cube map depth map [luft et al. 2006; mittr 2007; sainz 2008] render camera consid sam- pled represent scene. map textur memori gpu, fragment shader program check visibl directions. method call screen- space ambient occlus [mittr 2007] took differ depth values. depth differ obtain tangent space effici import sampl scheme develop screen-spac ambient occlus [toth et al. 2009]. horizon split ambient occlus [sainz 2008] gener evalu horizon map [max 1988] fly. recent work combin ambi- ent occlus one-bounc direct light address artifact screen-spac ambient occlus method render multipl depth layer imag [ritschel et al. 2009]. obscur ambient occlus open acces- sibil point size direct hemi- sphere, correspond occlud directions. definit feasible, result simpler effici evaluations. example, occlus defin volum tangent sphere open region [szirmay- kalo et al. 2009]. obscur ambient occlus popular ren- dere volumetr model [rezk-salama 2007; hernel et al. 2007; diaz et al. 2008; ruiz et al. 2008; ropinski et al. 2008]. notat mean ~x surfac point radianc comput ~y point occlud surfac d distanc between~x and~i r maximum distanc consid occlus ~ direct from~x to~i r paramet rai origin~x direct ~ angl surfac normal at~x ~ illumin hemispher lr(~x) reflect radianc lin(~x, ~) incid radianc point~x direct la ambient light intens fr(~x) diffus brdf a(~x) albedo o(~x) obscur w (~x) ambient transfer function (d) fuzzi membership occlud distanc d (d) step function 1 d > 0 0 tabl 1: notat paper. 3 gener ambient illumin model sake simplicity, let assum surfac diffuse. accord render equation, reflect radianc lr point~x obtain as: lr(~x) = lin(~x, ~) fr(~x)cos+ d, (1) fr(~x) brdf, cos+ geometr term. in- cident angl greater 90 degrees, i.e. light illumi- nate surfac neg cosin valu replac zero, indic superscript + cos+. occlus multipl scattering, incid illumina- tion lin(~x, ~) point ~x direct ~ necessarili equal ambient intens la. integrand render equat depend factors, incid illumination, materi properties, local ge- ometry. order decompos reflect radianc integr ac- cord factors, rewrit integr follow form: lr(~x) = a(~x) w (~x) la, (2) a(~x) = fr(~x)co + d = fr(~x) albedo surfac w (~x) ambient transfer func- tion ambient light: w (~x) = lin(~x, ~) la fr(~x) a(~x) cos+ d = 1 lin(~x, ~) la cos+ d. (3) note factor defin separ wavelength. ambient light intens zero wavelength, formula includ 0/0 factors. factor replac 0 correct interpretation. ambient transfer function defin equat 3 need incid radianc lin direct ~ . point ~y visibl ~x direc- tion ~ , space fill particip media, incid radianc equal exit radianc lr(~y) point ~y. surfac seen, shade point ~x said open direction, incid radianc la. however, meet intuit everydai experi effect far surfac replac average. experi real space fill particip media. space contain homogen particip media, radianc rai direct ~ chang accord volumetr render equation: dl(r, ~) dr =tl(r, ~)+ lin(r, ~ )p(~ , ~)d , r rai parameter, t extinct coeffici repre- sent probabl photonmateri collis unit dis- tance, s scatter coefficient, equal probabil- iti collis happen photon reflected, phase function p(~ , ~) probabl densiti reflect direc- tion. assum incid radianc lin differ am- bient intens surfaces, integr in-scatt term simplified: lin(r, ~ )p(~ , ~)d = lap(~ , ~)d = la. volumetr render equat get follow form: dl(r, ~) dr =tl(r, ~)+sla. solut differenti equat given close form: l(r, ~) = et rl(0, ~)+ s t la ( 1 et r ) . wish ambient intens scene, choos non-absorb media, i.e. t = s. indeed, case l(0, ~) = la boundari condit result solut l(r, ~) = la everywhere. let consid surfac provid boundari condit volumetr render equation. surfac point~i visibl direct ~ reflect radianc lr(~y), incid radianc point~x distanc d lin(~x, ~) = et dlr(~y)+la ( 1 et d ) . note equation, factor (d) = 1 et d comple- ment 1 (d) = et d express effect ambient light occlud shade point ~x, respectively. effect occlud diminish distance. consid particip media, open direct incid radianc ambient intens close direct radianc occluder, function fuzzi measur defin strongli direct ~ belong set open direct base distanc d occlus direction. exponenti function deriv physic analog signific drawback [ion et al. 2003]. non-zero ar- bitrarili larg distances, distant surfac need consid- er neglig effect. thus, practic fuzzi measur us function non-negative, monoton in- creas zero reach 1 finit distanc r. allow consider occlus nearby, i.e. closer r. particular valu r set applic de- veloper. increas value, shadow ambient oc- clusion larger softer. example, mendez et al. [mendez et al. 2005] propos follow function (d) = d r d < r 1 otherwise, (d)=d/r d r (d)=d/r d r (d)=0 d<r d r linearsquar rootclass ambient occlus (d)=1-exp(-td)1 d exponenti figur 1: exampl fuzzi membership functions. classic ambient occlus us non-fuzzi separation. local squar root good compromis global exponenti non- fuzzi separation. non-negative, monoton increas function used, 1 d suffici large, i.e. d greater radiu r consid neighborhood (figur 1). fuzzi measure, ambient transfer function writ- follow form: w (~x) = 1 (d(~))cos+ d+ 1 (1(d(~)))l r(~y(~)) la cos+ d. (4) term obscur valu [zhukov et al. 1998; ion et al. 2003] point~x: o(~x) = 1 (d(~))cos+ d. (5) ambient occlus obtain special case obscu- ranc set membership function zero distanc smaller r 1 (figur 1). second integr repres global illumin effects, i.e. ad- dition light bounces, contain radianc occlud lr(~y). accord equat 2, reflect radianc ~y express ambient transfer function lr(~y) = a(~y) w (~y) la. thus, substitut equat 4 obtain recurs formu- lation ambient reflectivity: w (~x) = o(~x)+ 1 (1(d(~)))a(~y(~))w (~y(~))cos+ d. neighborhood suffici small, w (~y) similar w (~x), write: w (~x) o(~x)+ 1 (1(d(~)))a(~y(~))w (~x)cos+ d, ambient transfer function w (~x) o(~x) 1 1 (1(d(~)))a(~y(~))cos+ d = (d(~))cos+ d (1(d(~)))a(~y(~))cos+ d . (6) let interpret formula. albedo small, ambient transfer function similar obscur value. however, albedo close 1, ambient transfer function get close 1, reduc darken obscurances. example, corner white room darker wall itself, correspond everydai observations. phenomenon known skiers. cloudi foggi weather, scratch bump high albedo snow invisible. ambient transfer function depend direct integrals, effici evalu requir fast algorithm estim integrals. 4 comput direct integr evalu direct integr equat 6 requir rai trace directions, costly. transform direct integr replac expens rai trac- ing oper simpl contain test, provid neighbor- hood r small allow assumpt rai inter- sect surfac interv [0,r]. assumpt impos restrict surfac curvature. shade point rai 1 intersect rai 2 intersect outer inner rai 3 intersect figur 2: replac rai trace contain tests. test point rai distanc r shade point region origin ray, rai intersect surface. instead test points, sampl point rai formal contain test, let assum surfac subdivid space outer camera inner part reach camera cross surface. defin characterist function i0(~p) 1 point ~p outer point zero otherwise. boundari inner outer parts, i.e. surfaces, belong inner definit (figur 2). characterist function i0(~p) easi defin height field displac map surfac (figur 3). propos con- text screen-spac ambient occlus method [mittr 2007; sainz 2008], content z-buffer provid innerout dis- tinction consid height field. point report occlud depth map, surfac separ point eye, characterist valu zero. point pass depth test, region eye, get valu 1. case, project surfac point repres pixel coordin content z-buffer. order evalu obscur integr contain tests, express dimension integral. point ),( yxh yx, height field z-buffer surfac repres depth buffer macrostructur polygon figur 3: exampl definit characterist func- tion. outer region i0 = 1 blank, inner region i0 = 0 filled. distanc d, fuzzi measur (d) integr deriv 0 d (0) = 0. integr do- main extend d r multipli integrand step function replac deriv zero dis- tanc greater d: (d) = d 0 (r)dr = r 0 (r)(d r)dr, (x) step function, 1 x 0 zero oth- erwise. similarly, complement fuzzi membership function, write: 1(d) = r d (r)dr = r 0 (r)(1 (d r))dr. substitut integr ambient transfer function, w (~x) r 0 (r)(d(~) r)cos+ ddr r 0 (r)(1 (d(~) r))a(~y(~))cos+ ddr . let consid rai equat ~x + ~r shade point ~x origin, ~ direction, distanc r rai parameter. condit (d(~) r) = 1 mean intersect happen closer r, equival condit point rai origin ~x + ~r inner region. instead check point ray, condit check few, m sampl uniformli distribut rai origin point~x+~r. uniformli distribut point are~x+~r/m,~x+~r2/m, . . . ,~x+~r. i0(~x+~ri/m) indic ith point outer region, condit point inner region indic product point indicators. approxim (d(~) r) (d(~) r)i (~x+~r) = m i=1 i0 ( ~x+~r m ) . practic number sampl m rai set 1 2. albedo a(~y) hit point occlud surfac relev occlus happens, i.e. (d(~) r) = (~x + ~r) = 0. accord model, need point ~y (~x + ~r) changes, difficult fit concept replac ray-intersect calcul contain- ment test. approxim replac ~y project point test posit occlus sur- face, denot a(~x+~r). innerout character approxim albedo, ambient transfer function w (~x) r 0 (r)i (~x+~r)cos+ ddr r 0 (r)(1i (~x+~r))a(x+~r)cos+ ddr . (7) 4.1 quasi-mont carlo integr order provid ambient transfer valu real-time, in- tegral equat 7 accur estim few, carefulli select samples. integrals, enu- merator, denominator. esti- mate samples, estim error correlated. comput ratio, divis com- pensat correl error suggest weight import sampl [powel swann 1966]. care sampl start uniform seri (x,y,z)i, = 1 . . .n unit cube, transform mimic integrand accord concept import sampling. sampl uniform seri (x,y,z)i poisson disc dis- tribut superior uniform blue-nois properties. sampl distribut poisson disc distribut obtain iter lloyd-relax [lloyd 1982]. uniform seri transform direct distances. un- fortunately, imposs target densiti exactli pro- portion integrand, aim sampl densiti equal integrand factor p(~,r) = (r) cos+ . us coordin (x,y) direct cosin distribution: ~ = ~t cos(2x) y +~bsin(2x) y +~n 1y, ~t , ~b, ~n, tangent, binormal, normal vectors, respectively. have cosin distribut point unit hemisphere, distanc r obtain densiti (r), transform z r = 1(z). note gener poisson disc distribut transform sampl point expens computa- tionally, case number sampl n small, seri gener once. pre-comput valu hardwir program code, is, obtain n sampl (~i,ri) discuss procedure, valu (xi,yi,zi) = ~iri (8) store file constant program. start application, sampl pass fragment shader constant array. fragment shader comput test point ~pi =~x+xi~t +yi~b+zi~n ~t , ~b, ~n, tangent, binormal, normal vectors, respectively. test point includ quadratur ambient transfer function: w (~x) n i=1 (~pi) nni=1(1i (~pi))a(~pi) . (9) requir m n contain test gener point av- erag numer denominator. make sens replac albedo formula radianc store pixel. replac includ effect direct point light indirect illumination. 4.2 nois reduct interleav sampl quasi-mont carlo quadratur error pixel, depend particular sampl quadrature. differ quasi-random number neighbor pixels, dot nois up. quasi-random num- ber pixel error correl replac dot nois stripes. unfortunately, stripe pixel nois disturbing. period pattern sampl neighborhood figur 4: interleav sampling. figur color repres quasi-random sequences. note arbitrari 4 4 squar in- clude colors, differ quasi-random sequenc rep- resented. order reduc error take excess number samples, appli interleav sampl [keller heidrich 2001] us differ set sampl pixel 4 4 pixel pattern, repeat sampl structur periodically. 16 differ sampl set obtain singl set rotat surfac normal vector random angl . rotat execut fragment shader get 16 (cos,sin) pair addit quasi-random sampl (xi,yi). error pixel 4 4 pixel pattern uncorrelated, successfulli reduc low-pass filter size. thus, interleav sampl 44 pixel pattern multipli effect sampl number 16 ad cost box-filt 44 pixel window (figur 4). note assumpt low-pass filter reduc error valid surfac visibl neighbor pixel. surfac significantli differ distanc dif- ferent illumin condit occupi neighbor pixels, ambient transfer function estim includ current pixel. thus, check depth dif- ferenc current neighbor pixel exce given limit. does, neighbor pixel includ averag operation. 1 sample, 720 fp 1 sample, 625 fp 4 samples, 700 fp 4 samples, 415 fp 8 samples, 430 fp 8 samples, 299 fp figur 5: comparison obscur result interleav sampl (left) interleav sampl (right). 4.3 distanc surfac method previou section us averag result con- tainment test approxim ambient transfer integrals, is, examin test point inner outer respect surface. however, inform avail- abl increas accuraci approximation. namely, practic cases, abl classifi point inner outer, determin distanc test point surfac given direction. particular methods, direct parallel axi z. content z- buffer defin separation, z-direct view direct clip space. read depth valu x,y coordin test point provid requir threshold z. character- istic function defin height field h(x,y), z = h(x,y) threshold. simpl straightforward applic distanc informa- tion elimin fals silhouett shadow show depth map base method (figur 6). suppos foreground object background object distanc greater r, inspect pixel background object visi- ble neighbor belong object. ambient transfer valu background estimated, sampl point neighborhood probabl fail depth test, object darken point, i.e. silhouett cast fake shadow. however, distanc greater r, darken- ing happen. problem solv check differ store depth valu z depth z sampl foreground object r fals silhouett shadow distant foreground object show shade point z* z background object point occlud local geometri shade point far foreground object. figur 6: fals silhouett shadow caus foreground object far shade surface. note wall corridor far door, shadow cast. point, report point occlud r > z z > 0 (figur 4.3). figur 7: imag (left) silhouett edg elimin (right). 5 implement run-tim propos ambient transfer function calcul implement post-process pixel shader. shader re- turn float4 variable, rgb channel store denom- inat ambient transfer function channel store enumer (equat 9). calcul us depth buffer (depthmap) store camera space z valu surfac nor- mal. tangent binorm vectors, matrix tbn transform- ing tangent space camera space reconstruct store normal. shader get current point posit tex- ture space (wpos) camera space (cpos). interleav sam- pling, shader us pixel coordin point. ran- dom rotat obtain textur noisemap, multipli tangent camera space transformation. offset equat 8 obtain constant arrai xyz, shift point tangent space, trans- form camera space (scpos) textur space (sspos), depth sdepth read depth buffer. finally, equa- tion 9 evalu accord result depth comparisons. follow shader program us singl sampl rai includ silhouett edg elimination, implement interleav sampling: sampler2d depthmap; // depth map sampler2d noisemap; // interleav sampl sampler2d albedomap; // albedo visibl point float4 ambienttransfer( float2 wpo : texcoord0, // textur space float3 cpo : texcoord1, // camera space float4 vpo : vpo // screen space ) : color { float depth = tex2d(depthmap, wpos).a; float3 t, b, n; // determin tangent space n = tex2d(depthmap,wpos).xyz; t = normalize(cross(n,float3(0,1,0.01))); b = cross(n,t); float3x3 tbn = float3x3(t, b, n); // interleav sampl float3 r1 = tex2d(noisemap, vpos.xy/4).xyz; float3 r3 = float3(0,0,1); float3 r2 = float3(r1.y, -r1.x, 0); tbn = mul(float3x3(r1,r2,r3), tbn); float4 w = float4(n, n, n, 0); // n = count (int k = 0; k < n; k++) { // transform sampl camera space float3 scpo = cpos+mul(xyz[k].xyz,tbn)*r; float4 sspo = mul(scpos, projtexmatrix); sspos.xi = sspos.xi / sspos.w; float sdepth = tex2d(depthmap, sspos.xy).a; // compar sampl depth depth buffer if(sdepth >= scpos.z - bias) w.a += 1; w.rgb -= tex2d(albedomap, sspos.xy); } return w; } case interleav sampling, shade pass follow low pass filtering. 6 result propos method implement directx/hlsl environ perform measur nvidia geforc 8800 gtx gpu 800600 resolution. figur 6 compar imag render propos model result environ lighting. sampl ray. scene consist 415.000 polygon render 180 fp constant shade 100 fp propos ambient transfer calculation. propos ambient transfer function w (equat 6) compar environ light obscur o (equat 5) figur 7. averag albedo textur carv object (0.6,0.3,0.3) wavelength primari colors. note unrealist darken obscur elimin applic new ambient transfer function. check occlus displac map sur- face z-buffer. fact, combin techniques. z-buffer base obscur respons oc- clusion objects, height field base obscur handl self-shadowing. note wai obscur valu obtain displac map surfac depth valu modifi fragment shader, accuraci prob- lem z-buffer eliminated. environ light ambient transfer w (~x) modul w (~x) figur 8: harbor render environ light propos ambient transfer function (100 fp 800600 resolut nv8800 gpu). 7 conclus paper propos gener ambient illumin model mimic local occlus multipl scatter shade point reduc excess darken ob- scuranc ambient occlus models. effect sum- mariz propos ambient transfer function. con- sider fast method comput ambient transfer function, replac ray-trac contain test height field z-buffer. finally, discuss im- provement applic interleav sampl elimin fals silhouett shadows. acknowledg work support nation offic research technolog otka k-719922 (hungary). refer bunnel, m. 2005. dynam ambient occlus indirect light- ing. gpu gem 2, m. parr, ed. addison-wesley, 223233. diaz, j., yela, h., vazquez, p. 2008. vicin occlu- sion maps: enhanc depth percept volumetr models. graphic international. hayden, l. 2002. production-readi global illumi- nation. tech. rep., siggraph cours note 16. sig02.course16.pdf.gz. hernell, f., ynnerman, a., ljung, p. 2007. effici ambient emiss tissu illumin local occlus multiresolut volum rendering. eurographics/ieee-vgtc symposium volum graphics, 18. hoberock, j., jia, y. 2007. high-qual ambient occlu- sion. gpu gem 3, h. nguyen, ed. addison-wesley, 257 274. environ light modul o(~x) modul w (~x) w (~x) figur 9: effect modul environ light obscurances, o(~x), propos ambient transfer function, w (~x). ambient transfer function shown right. iones, a., krupkin, a., sbert, m., zhukov, s. 2003. fast realist light video games. ieee graphic applic 23, 3, 5464. keller, a., heidrich, w. 2001. interleav sampling. render techniqu 2001 (proceed 12th euro- graphic workshop rendering), 269276. kontkanen, j., aila, t. 2006. ambient occlus anim characters. proceed 2006 eurograph symposium rendering. lloyd, s. 1982. squar quantiz pcm. ieee trans- action inform theori 28, 129137. luft, t., colditz, c., deussen, o. 2006. imag en- hancement unsharp mask depth buffer. acm trans. graph. 25, 3, 12061213. max, n. 1988. horizon mapping: shadow bump-map surfaces. visual 4, 2, 109117. mendez, a., sbert, m., cata, j., sunyer, n., fun- tane, s. 2005. real-tim obscur color bleeding. shaderx 4: advanc render techniques, w. engel, ed. charl river media. mittring, m. 2007. find gen cryengin 2. ad- vanc real-tim render 3d graphic game cours - siggraph 2007. 97121. pharr, m., green, s. 2004. ambient occlusion. gpu gems. addison-wesley, 279292. powell, m., swann, j. 1966. weight import sam- pling monte-carlo techniqu reduc variance. inst. maths. applics. 2, 228236. rezk-salama, c. 2007. production-readi gpu-bas monte- carlo volum raycasting. tech. rep. ritschel, t., grosch, t., seidel, h.-p. 2009. approxi- mate dynam global illumin imag space. proceed- ing acm siggraph symposium interact 3d graphic game (i3d). ropinski, t., meyer-spradow, j., diepenbrock, s., mensmann, j., hinrichs, k. h. 2008. interact vol- um render dynam ambient occlus color bleed- ing. graphic forum (eurograph 2008) 27, 2, 567 576. ruiz, m., boada, i., viola, i., bruckner, s., feixas, m., sbert, m. 2008. obscurance-bas volum render framework. proceed volum graphic 2008. sainz, m. 2008. real-tim depth buffer base ambient occlusion. game develop confer 08. shanmugam, p., arikan, o. 2007. hardwar acceler ambient occlus techniqu gpus. proceed 2007 symposium interact 3d graphics, 7380. szirmay-kalos, l., umenhoffer, t., toth, b., szecsi, l., sbert, m. 2009. volumetr ambient occlusion. ieee graphic applications. toth, b., umenhoffer, t., szirmay-kalos, l. 2009. effici post-process import sampling. shaderx 7, w. engel, ed. charl river media. zhukov, s., iones, a., kronin, g. 1998. ambient light illumin model. proceed eurograph render workshop, 4556.